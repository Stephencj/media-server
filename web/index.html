<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Server Admin</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
        }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; }
        h1 { color: #1e88e5; margin-bottom: 30px; }
        h2 { color: #90caf9; margin: 20px 0 15px; font-size: 1.2rem; }

        /* Auth */
        #auth-section { max-width: 400px; margin: 100px auto; }
        #auth-section h1 { text-align: center; }
        .tabs { display: flex; margin-bottom: 20px; }
        .tab { flex: 1; padding: 12px; background: #16213e; border: none; color: #888; cursor: pointer; }
        .tab.active { background: #1e88e5; color: white; }
        .tab:first-child { border-radius: 8px 0 0 8px; }
        .tab:last-child { border-radius: 0 8px 8px 0; }

        /* Forms */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #90caf9; font-size: 0.9rem; }
        input, select {
            width: 100%; padding: 12px; border: 1px solid #333;
            border-radius: 8px; background: #16213e; color: #eee; font-size: 1rem;
        }
        input:focus, select:focus { outline: none; border-color: #1e88e5; }
        button {
            padding: 12px 24px; border: none; border-radius: 8px;
            background: #1e88e5; color: white; font-size: 1rem; cursor: pointer;
            transition: background 0.2s;
        }
        button:hover { background: #1565c0; }
        button:disabled { background: #444; cursor: not-allowed; }
        .btn-secondary { background: #37474f; }
        .btn-secondary:hover { background: #455a64; }
        .btn-danger { background: #c62828; }
        .btn-danger:hover { background: #b71c1c; }
        .btn-sm { padding: 8px 16px; font-size: 0.9rem; }

        /* Cards */
        .card {
            background: #16213e; border-radius: 12px; padding: 20px; margin-bottom: 20px;
        }
        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px;
        }
        .card-header h2 { margin: 0; }

        /* Sources list */
        .source-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px; background: #1a1a2e; border-radius: 8px; margin-bottom: 10px;
        }
        .source-info { flex: 1; }
        .source-name { font-weight: 600; margin-bottom: 4px; }
        .source-path { font-size: 0.85rem; color: #888; font-family: monospace; }
        .source-meta { font-size: 0.8rem; color: #666; margin-top: 4px; }

        /* Stats */
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .stat {
            background: #1a1a2e; padding: 20px; border-radius: 8px; text-align: center;
        }
        .stat-value { font-size: 2rem; font-weight: 700; color: #1e88e5; }
        .stat-label { font-size: 0.85rem; color: #888; margin-top: 5px; }

        /* Messages */
        .error { color: #ef5350; font-size: 0.9rem; margin-top: 10px; }
        .success { color: #66bb6a; font-size: 0.9rem; margin-top: 10px; }
        .empty { color: #666; text-align: center; padding: 30px; }

        /* Header */
        header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #333;
        }
        header h1 { margin: 0; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .username { color: #90caf9; }

        /* Modal */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7); justify-content: center; align-items: center;
            z-index: 1000;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: #16213e; border-radius: 12px; padding: 25px;
            width: 90%; max-width: 500px;
        }
        .modal h2 { margin-bottom: 20px; }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }

        /* Inline form */
        .inline-form { display: flex; gap: 10px; }
        .inline-form input { flex: 1; }

        /* Scanning status */
        .scanning { display: flex; align-items: center; gap: 10px; color: #ffa726; }
        .spinner {
            width: 20px; height: 20px; border: 2px solid #333;
            border-top-color: #ffa726; border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Hide sections */
        .hidden { display: none !important; }

        /* Playlists */
        .playlist-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px; background: #1a1a2e; border-radius: 8px; margin-bottom: 10px;
            cursor: pointer; transition: background 0.2s;
        }
        .playlist-item:hover { background: #252542; }
        .playlist-name { font-weight: 600; margin-bottom: 4px; }
        .playlist-meta { font-size: 0.85rem; color: #888; }
        .playlist-actions { display: flex; gap: 8px; }

        /* Playlist Items (draggable) */
        .playlist-item-row {
            display: flex; align-items: center; gap: 12px;
            padding: 12px; background: #1a1a2e; border-radius: 8px; margin-bottom: 8px;
            cursor: grab;
        }
        .playlist-item-row:active { cursor: grabbing; }
        .playlist-item-row.dragging { opacity: 0.5; background: #2a2a4e; }
        .playlist-item-row.drag-over { border-top: 2px solid #1e88e5; }
        .drag-handle { color: #555; font-size: 1.2rem; cursor: grab; }
        .playlist-item-poster {
            width: 60px; height: 90px; background: #333; border-radius: 4px;
            object-fit: cover;
        }
        .playlist-item-info { flex: 1; }
        .playlist-item-title { font-weight: 600; margin-bottom: 4px; }
        .playlist-item-meta { font-size: 0.85rem; color: #888; }
        .playlist-item-duration { color: #666; font-size: 0.8rem; }

        /* Add to Playlist Dropdown */
        .dropdown-container { position: relative; display: inline-block; }
        .dropdown-menu {
            display: none; position: absolute; top: 100%; right: 0;
            background: #16213e; border-radius: 8px; min-width: 200px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 100;
            padding: 8px 0; margin-top: 4px;
        }
        .dropdown-menu.active { display: block; }
        .dropdown-item {
            padding: 10px 16px; cursor: pointer; transition: background 0.2s;
        }
        .dropdown-item:hover { background: #252542; }
        .dropdown-divider { height: 1px; background: #333; margin: 8px 0; }

        /* Toast notifications */
        .toast {
            position: fixed; bottom: 20px; right: 20px; padding: 12px 20px;
            background: #1e88e5; color: white; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 2000;
            animation: slideIn 0.3s ease;
        }
        .toast.success { background: #43a047; }
        .toast.error { background: #e53935; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Media Grid */
        .media-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px;
        }
        .media-card {
            position: relative; cursor: pointer; border-radius: 8px; overflow: hidden;
            transition: transform 0.2s;
        }
        .media-card:hover { transform: scale(1.05); }
        .media-poster {
            width: 100%; aspect-ratio: 2/3; background: #333; object-fit: cover;
        }
        .media-card-info {
            padding: 8px; background: #16213e;
        }
        .media-card-title { font-size: 0.9rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .media-card-year { font-size: 0.8rem; color: #888; }
        .media-card-actions {
            position: absolute; top: 8px; right: 8px;
        }

        /* Player Modal */
        .player-modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: #000; z-index: 3000; display: none;
        }
        .player-modal.active { display: flex; flex-direction: column; }
        .player-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 20px; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            position: absolute; top: 0; left: 0; right: 0; z-index: 10;
        }
        .player-title { font-size: 1.2rem; font-weight: 600; }
        .player-close { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }
        .player-video { flex: 1; width: 100%; background: #000; }
        .up-next {
            position: absolute; bottom: 80px; right: 20px;
            background: rgba(0,0,0,0.9); border-radius: 8px; padding: 15px;
            max-width: 300px; z-index: 10;
        }
        .up-next-label { font-size: 0.8rem; color: #888; margin-bottom: 8px; }
        .up-next-title { font-weight: 600; margin-bottom: 10px; }
        .up-next-actions { display: flex; gap: 10px; }
    </style>
</head>
<body>
    <!-- Auth Section -->
    <div id="auth-section">
        <h1>Media Server</h1>
        <div class="tabs">
            <button class="tab active" onclick="showAuthTab('login')">Login</button>
            <button class="tab" onclick="showAuthTab('register')">Register</button>
        </div>

        <div id="login-form">
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="login-username" placeholder="Enter username">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="login-password" placeholder="Enter password">
            </div>
            <button onclick="login()" style="width: 100%">Login</button>
            <div id="login-error" class="error"></div>
        </div>

        <div id="register-form" class="hidden">
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="register-username" placeholder="Choose username">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="register-email" placeholder="Enter email">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="register-password" placeholder="Choose password (min 6 chars)">
            </div>
            <button onclick="register()" style="width: 100%">Create Account</button>
            <div id="register-error" class="error"></div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="main-section" class="hidden">
        <div class="container">
            <header>
                <h1>Media Server</h1>
                <div class="user-info">
                    <span class="username" id="current-user"></span>
                    <button class="btn-secondary btn-sm" onclick="logout()">Logout</button>
                </div>
            </header>

            <!-- Stats -->
            <div class="card">
                <h2>Library</h2>
                <div class="stats">
                    <div class="stat">
                        <div class="stat-value" id="stat-movies">-</div>
                        <div class="stat-label">Movies</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="stat-shows">-</div>
                        <div class="stat-label">TV Shows</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="stat-sources">-</div>
                        <div class="stat-label">Sources</div>
                    </div>
                </div>
            </div>

            <!-- Media Sources -->
            <div class="card">
                <div class="card-header">
                    <h2>Media Sources</h2>
                    <div>
                        <button class="btn-secondary btn-sm" onclick="scanLibrary()" id="scan-btn">Scan Library</button>
                        <button class="btn-sm" onclick="showAddSource()">Add Source</button>
                    </div>
                </div>
                <div id="scan-status" class="scanning hidden">
                    <div class="spinner"></div>
                    <span>Scanning library...</span>
                </div>
                <div id="sources-list"></div>
            </div>

            <!-- Playlists -->
            <div class="card">
                <div class="card-header">
                    <h2>Playlists</h2>
                    <button class="btn-sm" onclick="showCreatePlaylist()">New Playlist</button>
                </div>
                <div id="playlists-list"></div>
            </div>

            <!-- Recent Media -->
            <div class="card">
                <h2>Recently Added</h2>
                <div id="recent-list"></div>
            </div>
        </div>
    </div>

    <!-- Add Source Modal -->
    <div class="modal-overlay" id="add-source-modal">
        <div class="modal">
            <h2>Add Media Source</h2>
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="source-name" placeholder="e.g., Movies, TV Shows">
            </div>
            <div class="form-group">
                <label>Path</label>
                <input type="text" id="source-path" placeholder="e.g., /mnt/media/movies">
            </div>
            <div class="form-group">
                <label>Type</label>
                <select id="source-type">
                    <option value="movies">Movies</option>
                    <option value="shows">TV Shows</option>
                </select>
            </div>
            <div id="add-source-error" class="error"></div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="hideAddSource()">Cancel</button>
                <button onclick="addSource()">Add Source</button>
            </div>
        </div>
    </div>

    <!-- Create/Edit Playlist Modal -->
    <div class="modal-overlay" id="playlist-modal">
        <div class="modal">
            <h2 id="playlist-modal-title">New Playlist</h2>
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="playlist-name" placeholder="Enter playlist name">
            </div>
            <div class="form-group">
                <label>Description (optional)</label>
                <input type="text" id="playlist-description" placeholder="Enter description">
            </div>
            <div id="playlist-modal-error" class="error"></div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="hidePlaylistModal()">Cancel</button>
                <button onclick="savePlaylist()">Save</button>
            </div>
        </div>
    </div>

    <!-- Playlist Detail Modal -->
    <div class="modal-overlay" id="playlist-detail-modal">
        <div class="modal" style="max-width: 700px;">
            <div class="card-header">
                <div>
                    <h2 id="playlist-detail-name"></h2>
                    <div id="playlist-detail-desc" class="playlist-meta"></div>
                </div>
                <div class="playlist-actions">
                    <button class="btn-sm" onclick="playPlaylist()">Play All</button>
                    <button class="btn-sm btn-secondary" onclick="shufflePlaylist()">Shuffle</button>
                    <button class="btn-sm btn-secondary" onclick="editCurrentPlaylist()">Edit</button>
                    <button class="btn-secondary" onclick="hidePlaylistDetail()">Close</button>
                </div>
            </div>
            <div id="playlist-items-list" style="max-height: 400px; overflow-y: auto; margin-top: 15px;"></div>
        </div>
    </div>

    <!-- Add to Playlist Modal -->
    <div class="modal-overlay" id="add-to-playlist-modal">
        <div class="modal" style="max-width: 400px;">
            <h2>Add to Playlist</h2>
            <div id="add-to-playlist-list" style="max-height: 300px; overflow-y: auto;"></div>
            <div class="modal-actions" style="margin-top: 15px;">
                <button class="btn-secondary" onclick="hideAddToPlaylist()">Cancel</button>
                <button onclick="showCreatePlaylistFromAdd()">New Playlist</button>
            </div>
        </div>
    </div>

    <!-- Video Player Modal -->
    <div class="player-modal" id="player-modal">
        <div class="player-header">
            <div class="player-title" id="player-title"></div>
            <button class="player-close" onclick="closePlayer()">&times;</button>
        </div>
        <video id="player-video" class="player-video" controls></video>
        <div class="up-next hidden" id="up-next">
            <div class="up-next-label">Up Next</div>
            <div class="up-next-title" id="up-next-title"></div>
            <div class="up-next-actions">
                <button class="btn-sm" onclick="playNextItem()">Play Now</button>
                <button class="btn-sm btn-secondary" onclick="cancelAutoPlay()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let token = localStorage.getItem('token');
        let currentUser = JSON.parse(localStorage.getItem('user') || 'null');

        // Check auth on load
        if (token && currentUser) {
            showDashboard();
        }

        function showAuthTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('login-form').classList.toggle('hidden', tab !== 'login');
            document.getElementById('register-form').classList.toggle('hidden', tab !== 'register');
        }

        async function login() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            errorEl.textContent = '';

            try {
                const res = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.error || 'Login failed');
                }

                const data = await res.json();
                token = data.token;
                currentUser = data.user;
                localStorage.setItem('token', token);
                localStorage.setItem('user', JSON.stringify(currentUser));
                showDashboard();
            } catch (err) {
                errorEl.textContent = err.message;
            }
        }

        async function register() {
            const username = document.getElementById('register-username').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const errorEl = document.getElementById('register-error');
            errorEl.textContent = '';

            try {
                const res = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password })
                });

                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.error || 'Registration failed');
                }

                const data = await res.json();
                token = data.token;
                currentUser = data.user;
                localStorage.setItem('token', token);
                localStorage.setItem('user', JSON.stringify(currentUser));
                showDashboard();
            } catch (err) {
                errorEl.textContent = err.message;
            }
        }

        function logout() {
            token = null;
            currentUser = null;
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            document.getElementById('auth-section').classList.remove('hidden');
            document.getElementById('main-section').classList.add('hidden');
        }

        function showDashboard() {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('main-section').classList.remove('hidden');
            document.getElementById('current-user').textContent = currentUser.username;
            loadData();
        }

        async function api(endpoint, options = {}) {
            const res = await fetch(endpoint, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                    ...options.headers
                }
            });
            if (res.status === 401) {
                logout();
                throw new Error('Session expired');
            }
            return res;
        }

        async function loadData() {
            await Promise.all([loadSources(), loadStats(), loadRecent()]);
        }

        async function loadSources() {
            try {
                const res = await api('/api/sources');
                const data = await res.json();
                const sources = data.sources || [];
                document.getElementById('stat-sources').textContent = sources.length;

                const list = document.getElementById('sources-list');
                if (sources.length === 0) {
                    list.innerHTML = '<div class="empty">No media sources configured. Add one to get started.</div>';
                    return;
                }

                list.innerHTML = sources.map(s => `
                    <div class="source-item">
                        <div class="source-info">
                            <div class="source-name">${escapeHtml(s.name)}</div>
                            <div class="source-path">${escapeHtml(s.path)}</div>
                            <div class="source-meta">Type: ${s.type} ${s.last_scan ? '• Last scan: ' + new Date(s.last_scan).toLocaleString() : ''}</div>
                        </div>
                        <button class="btn-danger btn-sm" onclick="deleteSource(${s.id})">Remove</button>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Failed to load sources:', err);
            }
        }

        async function loadStats() {
            try {
                const [moviesRes, showsRes] = await Promise.all([
                    api('/api/library/movies?limit=1'),
                    api('/api/library/shows?limit=1')
                ]);
                const movies = await moviesRes.json();
                const shows = await showsRes.json();
                document.getElementById('stat-movies').textContent = movies.total || 0;
                document.getElementById('stat-shows').textContent = shows.total || 0;
            } catch (err) {
                console.error('Failed to load stats:', err);
            }
        }

        async function loadRecent() {
            try {
                const res = await api('/api/library/recent?limit=5');
                const data = await res.json();
                const items = data.items || [];

                const list = document.getElementById('recent-list');
                if (items.length === 0) {
                    list.innerHTML = '<div class="empty">No media found. Add a source and scan your library.</div>';
                    return;
                }

                list.innerHTML = items.map(m => `
                    <div class="source-item">
                        <div class="source-info">
                            <div class="source-name">${escapeHtml(m.title)}</div>
                            <div class="source-path">${m.year || ''} ${m.type === 'tvshow' ? '• TV Show' : '• Movie'}</div>
                        </div>
                        <button class="btn-sm btn-secondary" onclick="showAddToPlaylist(${m.id}, '${m.type}')">+ Playlist</button>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Failed to load recent:', err);
            }
        }

        function showAddSource() {
            document.getElementById('add-source-modal').classList.add('active');
            document.getElementById('source-name').value = '';
            document.getElementById('source-path').value = '';
            document.getElementById('add-source-error').textContent = '';
        }

        function hideAddSource() {
            document.getElementById('add-source-modal').classList.remove('active');
        }

        async function addSource() {
            const name = document.getElementById('source-name').value;
            const path = document.getElementById('source-path').value;
            const type = document.getElementById('source-type').value;
            const errorEl = document.getElementById('add-source-error');
            errorEl.textContent = '';

            if (!name || !path) {
                errorEl.textContent = 'Name and path are required';
                return;
            }

            try {
                const res = await api('/api/sources', {
                    method: 'POST',
                    body: JSON.stringify({ name, path, type })
                });

                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.error || 'Failed to add source');
                }

                hideAddSource();
                loadSources();
            } catch (err) {
                errorEl.textContent = err.message;
            }
        }

        async function deleteSource(id) {
            if (!confirm('Remove this media source?')) return;

            try {
                await api(`/api/sources/${id}`, { method: 'DELETE' });
                loadSources();
            } catch (err) {
                alert('Failed to delete source: ' + err.message);
            }
        }

        async function scanLibrary() {
            const btn = document.getElementById('scan-btn');
            const status = document.getElementById('scan-status');

            btn.disabled = true;
            status.classList.remove('hidden');

            try {
                await api('/api/library/scan', { method: 'POST' });
                // Poll for completion or just wait
                setTimeout(async () => {
                    status.classList.add('hidden');
                    btn.disabled = false;
                    await loadData();
                }, 3000);
            } catch (err) {
                alert('Scan failed: ' + err.message);
                status.classList.add('hidden');
                btn.disabled = false;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============ PLAYLIST FUNCTIONS ============
        let playlists = [];
        let currentPlaylist = null;
        let currentPlaylistItems = [];
        let editingPlaylistId = null;
        let addToPlaylistMediaId = null;
        let addToPlaylistMediaType = null;
        let draggedItem = null;

        // Playlist playback state
        let playlistQueue = [];
        let currentPlaylistIndex = -1;
        let autoPlayTimer = null;

        async function loadPlaylists() {
            try {
                const res = await api('/api/playlists');
                const data = await res.json();
                playlists = data.items || [];
                renderPlaylists();
            } catch (err) {
                console.error('Failed to load playlists:', err);
            }
        }

        function renderPlaylists() {
            const list = document.getElementById('playlists-list');
            if (playlists.length === 0) {
                list.innerHTML = '<div class="empty">No playlists yet. Create one to get started.</div>';
                return;
            }

            list.innerHTML = playlists.map(p => `
                <div class="playlist-item" onclick="showPlaylistDetail(${p.id})">
                    <div>
                        <div class="playlist-name">${escapeHtml(p.name)}</div>
                        <div class="playlist-meta">${p.item_count} item${p.item_count !== 1 ? 's' : ''}</div>
                    </div>
                    <div class="playlist-actions" onclick="event.stopPropagation()">
                        <button class="btn-danger btn-sm" onclick="deletePlaylist(${p.id})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function showCreatePlaylist() {
            editingPlaylistId = null;
            document.getElementById('playlist-modal-title').textContent = 'New Playlist';
            document.getElementById('playlist-name').value = '';
            document.getElementById('playlist-description').value = '';
            document.getElementById('playlist-modal-error').textContent = '';
            document.getElementById('playlist-modal').classList.add('active');
        }

        function hidePlaylistModal() {
            document.getElementById('playlist-modal').classList.remove('active');
        }

        async function savePlaylist() {
            const name = document.getElementById('playlist-name').value.trim();
            const description = document.getElementById('playlist-description').value.trim();
            const errorEl = document.getElementById('playlist-modal-error');
            errorEl.textContent = '';

            if (!name) {
                errorEl.textContent = 'Name is required';
                return;
            }

            try {
                if (editingPlaylistId) {
                    await api(`/api/playlists/${editingPlaylistId}`, {
                        method: 'PUT',
                        body: JSON.stringify({ name, description })
                    });
                    showToast('Playlist updated', 'success');
                } else {
                    await api('/api/playlists', {
                        method: 'POST',
                        body: JSON.stringify({ name, description })
                    });
                    showToast('Playlist created', 'success');
                }
                hidePlaylistModal();
                await loadPlaylists();
                if (currentPlaylist && currentPlaylist.id === editingPlaylistId) {
                    showPlaylistDetail(editingPlaylistId);
                }
            } catch (err) {
                errorEl.textContent = err.message;
            }
        }

        async function deletePlaylist(id) {
            if (!confirm('Delete this playlist?')) return;

            try {
                await api(`/api/playlists/${id}`, { method: 'DELETE' });
                showToast('Playlist deleted', 'success');
                loadPlaylists();
                if (currentPlaylist && currentPlaylist.id === id) {
                    hidePlaylistDetail();
                }
            } catch (err) {
                showToast('Failed to delete playlist', 'error');
            }
        }

        async function showPlaylistDetail(id) {
            try {
                const res = await api(`/api/playlists/${id}`);
                const data = await res.json();
                currentPlaylist = data.playlist;
                currentPlaylistItems = data.items || [];

                document.getElementById('playlist-detail-name').textContent = currentPlaylist.name;
                document.getElementById('playlist-detail-desc').textContent = currentPlaylist.description || '';
                renderPlaylistItems();
                document.getElementById('playlist-detail-modal').classList.add('active');
            } catch (err) {
                showToast('Failed to load playlist', 'error');
            }
        }

        function hidePlaylistDetail() {
            document.getElementById('playlist-detail-modal').classList.remove('active');
            currentPlaylist = null;
            currentPlaylistItems = [];
        }

        function renderPlaylistItems() {
            const list = document.getElementById('playlist-items-list');
            if (currentPlaylistItems.length === 0) {
                list.innerHTML = '<div class="empty">This playlist is empty. Add items from your media library.</div>';
                return;
            }

            list.innerHTML = currentPlaylistItems.map((item, index) => `
                <div class="playlist-item-row" draggable="true" data-index="${index}" data-id="${item.id}"
                     ondragstart="handleDragStart(event)" ondragover="handleDragOver(event)"
                     ondragenter="handleDragEnter(event)" ondragleave="handleDragLeave(event)"
                     ondrop="handleDrop(event)" ondragend="handleDragEnd(event)">
                    <span class="drag-handle">&#9776;</span>
                    ${item.poster_path ? `<img src="https://image.tmdb.org/t/p/w92${item.poster_path}" class="playlist-item-poster" alt="">` : '<div class="playlist-item-poster"></div>'}
                    <div class="playlist-item-info" onclick="playPlaylistItem(${index})">
                        <div class="playlist-item-title">${escapeHtml(item.title)}</div>
                        <div class="playlist-item-meta">${item.year || ''} ${item.resolution || ''}</div>
                        <div class="playlist-item-duration">${formatDuration(item.duration)}</div>
                    </div>
                    <button class="btn-danger btn-sm" onclick="removeFromPlaylist(${item.id}, ${item.media_id}, '${item.media_type}')">Remove</button>
                </div>
            `).join('');
        }

        function editCurrentPlaylist() {
            if (!currentPlaylist) return;
            editingPlaylistId = currentPlaylist.id;
            document.getElementById('playlist-modal-title').textContent = 'Edit Playlist';
            document.getElementById('playlist-name').value = currentPlaylist.name;
            document.getElementById('playlist-description').value = currentPlaylist.description || '';
            document.getElementById('playlist-modal-error').textContent = '';
            document.getElementById('playlist-modal').classList.add('active');
        }

        async function removeFromPlaylist(itemId, mediaId, mediaType) {
            if (!currentPlaylist) return;
            try {
                await api(`/api/playlists/${currentPlaylist.id}/items/${mediaId}?type=${mediaType}`, { method: 'DELETE' });
                showToast('Removed from playlist', 'success');
                showPlaylistDetail(currentPlaylist.id);
                loadPlaylists();
            } catch (err) {
                showToast('Failed to remove item', 'error');
            }
        }

        // Drag and Drop
        function handleDragStart(e) {
            draggedItem = e.target;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDragEnter(e) {
            e.preventDefault();
            const row = e.target.closest('.playlist-item-row');
            if (row && row !== draggedItem) {
                row.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            const row = e.target.closest('.playlist-item-row');
            if (row) {
                row.classList.remove('drag-over');
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            const row = e.target.closest('.playlist-item-row');
            if (row && draggedItem && row !== draggedItem) {
                const fromIndex = parseInt(draggedItem.dataset.index);
                const toIndex = parseInt(row.dataset.index);
                reorderPlaylistItems(fromIndex, toIndex);
            }
            if (row) row.classList.remove('drag-over');
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.playlist-item-row').forEach(r => r.classList.remove('drag-over'));
            draggedItem = null;
        }

        async function reorderPlaylistItems(fromIndex, toIndex) {
            if (!currentPlaylist) return;

            // Reorder locally
            const items = [...currentPlaylistItems];
            const [moved] = items.splice(fromIndex, 1);
            items.splice(toIndex, 0, moved);
            currentPlaylistItems = items;
            renderPlaylistItems();

            // Send to server
            const itemIds = items.map(i => i.id);
            try {
                await api(`/api/playlists/${currentPlaylist.id}/reorder`, {
                    method: 'PUT',
                    body: JSON.stringify({ item_ids: itemIds })
                });
            } catch (err) {
                showToast('Failed to reorder', 'error');
                showPlaylistDetail(currentPlaylist.id);
            }
        }

        // Add to Playlist
        function showAddToPlaylist(mediaId, mediaType) {
            addToPlaylistMediaId = mediaId;
            addToPlaylistMediaType = mediaType;

            const list = document.getElementById('add-to-playlist-list');
            if (playlists.length === 0) {
                list.innerHTML = '<div class="empty">No playlists. Create one first.</div>';
            } else {
                list.innerHTML = playlists.map(p => `
                    <div class="dropdown-item" onclick="addToPlaylist(${p.id})">${escapeHtml(p.name)}</div>
                `).join('');
            }
            document.getElementById('add-to-playlist-modal').classList.add('active');
        }

        function hideAddToPlaylist() {
            document.getElementById('add-to-playlist-modal').classList.remove('active');
            addToPlaylistMediaId = null;
            addToPlaylistMediaType = null;
        }

        async function addToPlaylist(playlistId) {
            if (!addToPlaylistMediaId) return;

            try {
                await api(`/api/playlists/${playlistId}/items/${addToPlaylistMediaId}?type=${addToPlaylistMediaType}`, { method: 'POST' });
                showToast('Added to playlist', 'success');
                hideAddToPlaylist();
                loadPlaylists();
            } catch (err) {
                showToast('Failed to add to playlist', 'error');
            }
        }

        function showCreatePlaylistFromAdd() {
            hideAddToPlaylist();
            showCreatePlaylist();
        }

        // Sequential Playback
        function playPlaylist() {
            if (currentPlaylistItems.length === 0) return;
            playlistQueue = [...currentPlaylistItems];
            currentPlaylistIndex = 0;
            hidePlaylistDetail();
            playCurrentQueueItem();
        }

        function shufflePlaylist() {
            if (currentPlaylistItems.length === 0) return;
            playlistQueue = [...currentPlaylistItems].sort(() => Math.random() - 0.5);
            currentPlaylistIndex = 0;
            hidePlaylistDetail();
            playCurrentQueueItem();
        }

        function playPlaylistItem(index) {
            playlistQueue = [...currentPlaylistItems];
            currentPlaylistIndex = index;
            hidePlaylistDetail();
            playCurrentQueueItem();
        }

        function playCurrentQueueItem() {
            if (currentPlaylistIndex < 0 || currentPlaylistIndex >= playlistQueue.length) {
                closePlayer();
                return;
            }

            const item = playlistQueue[currentPlaylistIndex];
            document.getElementById('player-title').textContent = item.title;
            document.getElementById('player-modal').classList.add('active');

            const video = document.getElementById('player-video');
            const streamUrl = `/api/stream/${item.media_id}/direct?token=${token}&type=${item.media_type}`;
            video.src = streamUrl;
            video.play();

            video.onended = onMediaComplete;
            video.onerror = () => {
                // Try HLS fallback
                const hlsUrl = `/api/stream/${item.media_id}/manifest.m3u8?token=${token}&type=${item.media_type}`;
                if (Hls && Hls.isSupported()) {
                    const hls = new Hls();
                    hls.loadSource(hlsUrl);
                    hls.attachMedia(video);
                    hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
                } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                    video.src = hlsUrl;
                    video.play();
                }
            };
        }

        function onMediaComplete() {
            const nextIndex = currentPlaylistIndex + 1;
            if (nextIndex < playlistQueue.length) {
                const nextItem = playlistQueue[nextIndex];
                document.getElementById('up-next-title').textContent = nextItem.title;
                document.getElementById('up-next').classList.remove('hidden');

                autoPlayTimer = setTimeout(() => {
                    playNextItem();
                }, 10000);
            } else {
                closePlayer();
            }
        }

        function playNextItem() {
            cancelAutoPlay();
            currentPlaylistIndex++;
            playCurrentQueueItem();
        }

        function cancelAutoPlay() {
            if (autoPlayTimer) {
                clearTimeout(autoPlayTimer);
                autoPlayTimer = null;
            }
            document.getElementById('up-next').classList.add('hidden');
        }

        function closePlayer() {
            cancelAutoPlay();
            const video = document.getElementById('player-video');
            video.pause();
            video.src = '';
            document.getElementById('player-modal').classList.remove('active');
            playlistQueue = [];
            currentPlaylistIndex = -1;
        }

        // Helper functions
        function formatDuration(seconds) {
            if (!seconds) return '';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            if (h > 0) return `${h}h ${m}m`;
            return `${m}m`;
        }

        function showToast(message, type = '') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Update loadData to include playlists
        const originalLoadData = loadData;
        loadData = async function() {
            await originalLoadData();
            await loadPlaylists();
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</body>
</html>
